<!DOCTYPE html>
<html>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.2/angular.min.js"></script>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

<script>
    var AddressType = {
        TO: 1,
        CC: 2,
        BCC: 3,
    };

    var app = angular.module("myEmailApp", []);

    app.service('EmailService', ['$http', function($http) {

        this.sendEmail = function sendEmail(email) {
            return $http({
                method: 'POST',
                url: '/send-email',
                data: {
                    toList: email.to,
                    ccList: email.cc,
                    bccList: email.bcc,
                    subject: email.subject,
                    msg: email.message
                },
                headers: 'Accept:application/json'
            });
        }

    }]);

    app.controller('myCtrl', ['$scope', 'EmailService', function($scope, EmailService) {
        $scope.toAddressList = [];
        $scope.ccAddressList = [];
        $scope.bccAddressList = [];
        $scope.showMe = false;
        $scope.content = "";
        $scope.errortext = "";
        $scope.waiting = false;

        $scope.addAddress = function(list) {
            $scope.content = "";
            $scope.errortext = "";
            $scope.waiting = false;
            if (!$scope.addMe) { return; }
            if (($scope.toAddressList.indexOf($scope.addMe) == -1) && ($scope.ccAddressList.indexOf($scope.addMe) == -1) && ($scope.bccAddressList.indexOf($scope.addMe) == -1)) {
                list.push($scope.addMe);
                console.log($scope);
                $scope.addr = $scope.toAddressList.join();
            }
            else {
                $scope.errortext = "The address is already in the list.";
            }
        }

        $scope.addToAddress = function() {
            $scope.addAddress($scope.toAddressList);
        }

        $scope.addCcAddress = function() {
            $scope.addAddress($scope.ccAddressList);
        }

        $scope.addBccAddress = function() {
            $scope.addAddress($scope.bccAddressList);
        }

        $scope.removeAddress = function(t, x) {
            $scope.content = "";
            $scope.errortext = "";
            if (t == AddressType.TO) {
                $scope.toAddressList.splice(x, 1);
                $scope.addr = $scope.toAddressList.join();
            }
            if (t == AddressType.CC) {
                $scope.ccAddressList.splice(x, 1);
            }
            if (t == AddressType.BCC) {
                $scope.bccAddressList.splice(x, 1);
            }
        }

        $scope.removeToAddress = function(x) {
            $scope.removeAddress(AddressType.TO, x);
        }

        $scope.removeCcAddress = function(x) {
            $scope.removeAddress(AddressType.CC, x);
        }

        $scope.removeBccAddress = function(x) {
            $scope.removeAddress(AddressType.BCC, x);
        }

        $scope.sendEmail = function() {

            var email = {
                to: $scope.toAddressList.join(),
                cc: $scope.ccAddressList.join(),
                bcc: $scope.bccAddressList.join(),
                subject: $scope.subject,
                message: $scope.body
            }

            $scope.content = "";
            $scope.errortext = "";
            $scope.waiting = true;

            EmailService.sendEmail(email).then(function(response) {

                if (response.data.successFlag == true) {
                    $scope.content = "Ok";
                }
                else {
                    $scope.content = "Fail";
                }
                $scope.waiting = false;
            }, function(response) {
                $scope.content = response;
                $scope.waiting = false;
            });


        };
    }]);
</script>

<body>


    <div ng-app="myEmailApp" ng-cloak ng-controller="myCtrl" class="container">
        <div>
            <h1>Send Email</h1>

            <div>

                <label for="usr">To:</label>
                <span ng-repeat="x in toAddressList" class="badge badge-pill badge-info">
            {{x}}<span ng-click="removeToAddress($index)" style="cursor:pointer;" class="l-0 badge badge-light">&times;</span>
                </span>
                <span ng-repeat="x in ccAddressList" class="badge badge-pill badge-success">
                {{x}}<span ng-click="removeCcAddress($index)" style="cursor:pointer;" class="l-0 badge badge-light">&times;</span>
                </span>
                <span ng-repeat="x in bccAddressList" class="badge badge-pill badge-dark">
                {{x}}<span ng-click="removeBccAddress($index)" style="cursor:pointer;" class="l-0 badge badge-light">&times;</span>
                </span>
            </div>

            <form name="addressForm">
                <div class="input-group">
                    <input type="text" name="addressList" ng-model="addressList" style="display: none;" />
                    <input placeholder="Add To Address" name="addMe" ng-model="addMe" class="form-control" type="email" required>
                    <div class="input-group-append">
                        <button ng-click="addToAddress()" class="btn btn-info">To</button>
                        <button ng-click="addCcAddress()" class="btn btn-success">CC</button>
                        <button ng-click="addBccAddress()" class="btn btn-dark">bCC</button>
                    </div>
                </div>
            </form>

            <form name="emailForm" ng-model="emailForm">
                <input type="hidden" class="form-control" name="addr" id="addr" ng-model="addr" required>
                <div class="form-group">
                    <label for="usr">Subject:</label>
                    <input type="text" class="form-control" name="subject" id="subject" ng-model="subject" required>
                </div>
                <div class="form-group">
                    <label for="comment">Body:</label>
                    <textarea class="form-control" rows="5" id="body" name="body" ng-model="body" required></textarea>
                </div>

                <button type="button" class="btn btn-primary btn-block" ng-disabled="emailForm.subject.$invalid || emailForm.body.$invalid || emailForm.addr.$invalid || waiting" ng-click="sendEmail()">Send<i class="fa fa-spinner fa-spin"ng-show="waiting"></i></button>
            </form>
            <div class="pt-1">
                <div ng-show="errortext" class="alert alert-primary alert-dismissible">
                    {{errortext}}
                </div>
                <div ng-show="content == 'Ok'" class="alert alert-success alert-dismissible">
                    {{content}}
                </div>
                <div ng-show="content == 'Fail'" class="alert alert-warning alert-dismissible">
                    {{content}}
                </div>
            </div>
        </div>
    </div>


</body>

</html>
